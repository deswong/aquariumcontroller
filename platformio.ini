; ============================================================================
; ESP32-S3 Aquarium Controller - Optimized Configuration
; ============================================================================
; Hardware: ESP32-S3 with PSRAM (recommended: ESP32-S3-DevKitC-1)
; Framework: Arduino
; Features: WiFi, Web Server, MQTT, OLED Display, Sensor Control
; ============================================================================

[platformio]
default_envs = esp32s3dev

; ============================================================================
; ESP32-S3 PRIMARY BUILD (RECOMMENDED)
; ============================================================================
[env:esp32s3dev]
platform = espressif32
board = esp32-s3-devkitc-1
framework = arduino

monitor_speed = 115200
upload_speed = 921600

; Custom partition table for 16MB flash
board_build.partitions = partitions_s3_16mb.csv
board_build.flash_mode = qio
board_build.flash_size = 16MB

; SPIFFS filesystem configuration
board_build.filesystem = spiffs
; Upload only firmware by default (preserves SPIFFS data)
; Use 'pio run -t uploadfs' to update web files separately
upload_flags = 
    --before=default_reset
    --after=hard_reset

; ESP32-S3 specific optimizations
board_build.arduino.memory_type = qio_opi  ; Use PSRAM
board_build.f_cpu = 240000000L
board_build.f_flash = 80000000L

lib_deps = 
    bblanchon/ArduinoJson@^6.21.3
    knolleary/PubSubClient@^2.8
    milesburton/DallasTemperature@^3.11.0
    paulstoffregen/OneWire@^2.3.7
    https://github.com/me-no-dev/ESPAsyncWebServer.git
    me-no-dev/AsyncTCP@^1.1.1
    br3ttb/PID@^1.2.1
    olikraus/U8g2@^2.35.9

build_flags = 
    ; ESP32-S3 optimizations
    -D ARDUINO_ESP32S3_DEV
    -D BOARD_HAS_PSRAM
    -D CONFIG_SPIRAM_CACHE_WORKAROUND
    -D CONFIG_SPIRAM_USE_MALLOC
    
    ; AsyncTCP optimizations for S3
    -D CONFIG_ASYNC_TCP_RUNNING_CORE=1
    -D CONFIG_ASYNC_TCP_USE_WDT=0
    -D CONFIG_ASYNC_TCP_PRIORITY=10
    -D CONFIG_ASYNC_TCP_QUEUE_SIZE=128
    
    ; Performance optimizations
    -D CORE_DEBUG_LEVEL=3
    -O2                                 ; Optimize for speed
    -D CONFIG_FREERTOS_HZ=1000         ; 1ms tick for better timing
    
    ; Disable unused features to save memory
    -D CONFIG_BT_ENABLED=0
    -D CONFIG_BTDM_CTRL_MODE_BTDM_MODE=0
    -D CONFIG_BLUEDROID_ENABLED=0
    
    ; Display optimizations
    -D OLED_FAST_MODE                   ; Enable fast display updates
    -D OLED_USE_PSRAM                   ; Use PSRAM for display buffers
    
    ; Pattern learning optimizations (uses S3 AI acceleration)
    -D USE_ESP32S3_AI_ACCELERATION
    -D PATTERN_LEARNING_ENHANCED
    
    ; Water change prediction with larger history
    -D WC_HISTORY_SIZE=500              ; Increased from 30 (uses PSRAM)
    
    ; Event logging with larger buffer for 16MB flash
    -D EVENT_LOG_MAX_ENTRIES=5000       ; 5000 entries (~400KB) with 4MB SPIFFS
    -D ML_DATA_ENABLED                  ; Enable ML data partition
    
lib_ldf_mode = deep+

; ============================================================================
; ESP32 LEGACY BUILD (For older hardware - DEPRECATED)
; ============================================================================
[env:esp32dev]
platform = espressif32
board = esp32dev  ; or esp32-wroom-32
framework = arduino

monitor_speed = 115200
upload_speed = 921600

board_build.partitions = partitions.csv

lib_deps = 
    bblanchon/ArduinoJson@^6.21.3
    knolleary/PubSubClient@^2.8
    milesburton/DallasTemperature@^3.11.0
    paulstoffregen/OneWire@^2.3.7
    ; ayushsharma82/AsyncElegantOTA@^2.2.7  ; Library not available
    https://github.com/me-no-dev/ESPAsyncWebServer.git
    me-no-dev/AsyncTCP@^1.1.1
    br3ttb/PID@^1.2.1
    olikraus/U8g2@^2.35.9

build_flags = 
    -D CONFIG_ASYNC_TCP_RUNNING_CORE=1
    -D CONFIG_ASYNC_TCP_USE_WDT=0
    -DCORE_DEBUG_LEVEL=3
    -D CONFIG_BT_ENABLED=0              ; Disable Bluetooth to free up RAM/Flash
    -D CONFIG_BTDM_CTRL_MODE_BTDM_MODE=0
    -D CONFIG_BLUEDROID_ENABLED=0
    
lib_ldf_mode = deep+

[env:native]
platform = native
test_framework = unity
build_flags = 
    -D UNIT_TEST
    -D NATIVE
    -std=c++11
lib_deps = 
    throwtheswitch/Unity@^2.5.2

; Individual test environments to avoid symbol conflicts
[env:native_main]
platform = native
test_framework = unity
test_filter = test_main
build_flags = 
    -D UNIT_TEST
    -D NATIVE
    -std=c++11
lib_deps = 
    throwtheswitch/Unity@^2.5.2

[env:native_dosing]
platform = native
test_framework = unity
test_filter = test_dosing_pump
build_flags = 
    -D UNIT_TEST
    -D NATIVE
    -std=c++11
lib_deps = 
    throwtheswitch/Unity@^2.5.2

[env:native_ntp]
platform = native
test_framework = unity
test_filter = test_ntp_sync
build_flags = 
    -D UNIT_TEST
    -D NATIVE
    -std=c++11
lib_deps = 
    throwtheswitch/Unity@^2.5.2

[env:native_integration]
platform = native
test_framework = unity
test_filter = test_integration
build_flags = 
    -D UNIT_TEST
    -D NATIVE
    -std=c++11
lib_deps = 
    throwtheswitch/Unity@^2.5.2

[env:native_time_prop]
platform = native
test_framework = unity
test_filter = test_time_proportional
build_flags = 
    -D UNIT_TEST
    -D NATIVE
    -std=c++11
lib_deps = 
    throwtheswitch/Unity@^2.5.2

[env:native_working]
platform = native
test_framework = unity
test_filter = test_working
build_flags = 
    -D UNIT_TEST
    -D NATIVE
    -std=c++11
lib_deps = 
    throwtheswitch/Unity@^2.5.2

[env:native_config_manager]
platform = native
test_framework = unity
test_filter = test_config_manager
build_flags = 
    -D UNIT_TEST
    -D NATIVE
    -std=c++11
lib_deps = 
    throwtheswitch/Unity@^2.5.2

[env:native_wc_timestamps]
platform = native
test_framework = unity
test_filter = test_water_change_timestamps
build_flags = 
    -D UNIT_TEST
    -D NATIVE
    -std=c++11
lib_deps = 
    throwtheswitch/Unity@^2.5.2

[env:native_wc_history]
platform = native
test_framework = unity
test_filter = test_water_change_history
build_flags = 
    -D UNIT_TEST
    -D NATIVE
    -std=c++11
lib_deps = 
    throwtheswitch/Unity@^2.5.2

; ESP32 test environments (individual tests to avoid conflicts)
[env:esp32_working]
platform = espressif32
board = esp32dev
framework = arduino
test_framework = unity
test_filter = test_working

monitor_speed = 115200
upload_speed = 921600

lib_deps = 
    bblanchon/ArduinoJson@^6.21.3
    knolleary/PubSubClient@^2.8
    milesburton/DallasTemperature@^3.11.0
    paulstoffregen/OneWire@^2.3.7
    https://github.com/me-no-dev/ESPAsyncWebServer.git
    me-no-dev/AsyncTCP@^1.1.1
    br3ttb/PID@^1.2.1
    olikraus/U8g2@^2.35.9

build_flags = 
    -D CONFIG_ASYNC_TCP_RUNNING_CORE=1
    -D CONFIG_ASYNC_TCP_USE_WDT=0
    -DCORE_DEBUG_LEVEL=3
    -D CONFIG_BT_ENABLED=0              ; Disable Bluetooth
    -D CONFIG_BTDM_CTRL_MODE_BTDM_MODE=0
    -D CONFIG_BLUEDROID_ENABLED=0
    -D UNIT_TEST
    
lib_ldf_mode = deep+

[env:esp32_integration]
platform = espressif32
board = esp32dev
framework = arduino
test_framework = unity
test_filter = test_integration

monitor_speed = 115200
upload_speed = 921600

lib_deps = 
    bblanchon/ArduinoJson@^6.21.3
    knolleary/PubSubClient@^2.8
    milesburton/DallasTemperature@^3.11.0
    paulstoffregen/OneWire@^2.3.7
    https://github.com/me-no-dev/ESPAsyncWebServer.git
    me-no-dev/AsyncTCP@^1.1.1
    br3ttb/PID@^1.2.1
    olikraus/U8g2@^2.35.9

build_flags = 
    -D CONFIG_ASYNC_TCP_RUNNING_CORE=1
    -D CONFIG_ASYNC_TCP_USE_WDT=0
    -DCORE_DEBUG_LEVEL=3
    -D CONFIG_BT_ENABLED=0              ; Disable Bluetooth
    -D CONFIG_BTDM_CTRL_MODE_BTDM_MODE=0
    -D CONFIG_BLUEDROID_ENABLED=0
    -D UNIT_TEST
    
lib_ldf_mode = deep+

[env:esp32_config_manager]
platform = espressif32
board = esp32dev
framework = arduino
test_framework = unity
test_filter = test_config_manager

monitor_speed = 115200
upload_speed = 921600

lib_deps = 
    bblanchon/ArduinoJson@^6.21.3

build_flags = 
    -D CONFIG_ASYNC_TCP_RUNNING_CORE=1
    -D CONFIG_ASYNC_TCP_USE_WDT=0
    -DCORE_DEBUG_LEVEL=3
    -D CONFIG_BT_ENABLED=0
    -D CONFIG_BTDM_CTRL_MODE_BTDM_MODE=0
    -D CONFIG_BLUEDROID_ENABLED=0
    -D UNIT_TEST
    
lib_ldf_mode = deep+

[env:esp32_wc_timestamps]
platform = espressif32
board = esp32dev
framework = arduino
test_framework = unity
test_filter = test_water_change_timestamps

monitor_speed = 115200
upload_speed = 921600

lib_deps = 
    bblanchon/ArduinoJson@^6.21.3

build_flags = 
    -D CONFIG_ASYNC_TCP_RUNNING_CORE=1
    -D CONFIG_ASYNC_TCP_USE_WDT=0
    -DCORE_DEBUG_LEVEL=3
    -D CONFIG_BT_ENABLED=0
    -D CONFIG_BTDM_CTRL_MODE_BTDM_MODE=0
    -D CONFIG_BLUEDROID_ENABLED=0
    -D UNIT_TEST
    
lib_ldf_mode = deep+

[env:esp32_wc_history]
platform = espressif32
board = esp32dev
framework = arduino
test_framework = unity
test_filter = test_water_change_history

monitor_speed = 115200
upload_speed = 921600

lib_deps = 
    bblanchon/ArduinoJson@^6.21.3

build_flags = 
    -D CONFIG_ASYNC_TCP_RUNNING_CORE=1
    -D CONFIG_ASYNC_TCP_USE_WDT=0
    -DCORE_DEBUG_LEVEL=3
    -D CONFIG_BT_ENABLED=0
    -D CONFIG_BTDM_CTRL_MODE_BTDM_MODE=0
    -D CONFIG_BLUEDROID_ENABLED=0
    -D UNIT_TEST
    
lib_ldf_mode = deep+
